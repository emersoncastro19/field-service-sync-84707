// Supabase Edge Function para env√≠o de emails
// Esta funci√≥n puede usar SendGrid, Mailgun, AWS SES, o el servicio SMTP de Supabase

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface EmailRequest {
  to: string;
  subject: string;
  html: string;
  text?: string;
}

serve(async (req) => {
  // Manejar preflight CORS
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const emailData: EmailRequest = await req.json()

    // Validar datos
    if (!emailData.to || !emailData.subject || !emailData.html) {
      return new Response(
        JSON.stringify({ error: 'Datos de email incompletos' }),
        { 
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      )
    }

    // OPCI√ìN 1: Usar SendGrid (Recomendado)
    // Configura tu API key de SendGrid en las variables de entorno de Supabase
    const sendGridApiKey = Deno.env.get('SENDGRID_API_KEY')
    
    if (sendGridApiKey) {
      const sendGridResponse = await fetch('https://api.sendgrid.com/v3/mail/send', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${sendGridApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          personalizations: [{
            to: [{ email: emailData.to }]
          }],
          from: {
            email: Deno.env.get('SENDGRID_FROM_EMAIL') || 'noreply@serviciotecnico.com',
            name: 'Sistema de Gesti√≥n T√©cnica'
          },
          subject: emailData.subject,
          content: [
            {
              type: 'text/html',
              value: emailData.html
            },
            ...(emailData.text ? [{
              type: 'text/plain',
              value: emailData.text
            }] : [])
          ]
        })
      })

      if (!sendGridResponse.ok) {
        const errorText = await sendGridResponse.text()
        console.error('Error SendGrid:', errorText)
        throw new Error(`Error enviando email con SendGrid: ${errorText}`)
      }

      return new Response(
        JSON.stringify({ 
          success: true, 
          message: 'Email enviado exitosamente',
          provider: 'SendGrid'
        }),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      )
    }

    // OPCI√ìN 2: Usar Resend (Muy popular y f√°cil)
    // Plan gratuito: 3,000 emails/mes
    const resendApiKey = Deno.env.get('RESEND_API_KEY')
    
    if (resendApiKey) {
      const resendFromEmail = Deno.env.get('RESEND_FROM_EMAIL') || 'Sistema de Gesti√≥n T√©cnica <onboarding@resend.dev>'
      
      console.log('üìß Usando Resend para enviar email')
      console.log('üìß From:', resendFromEmail)
      console.log('üìß To:', emailData.to)
      console.log('üìß Subject:', emailData.subject)
      
      const resendResponse = await fetch('https://api.resend.com/emails', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${resendApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          from: resendFromEmail,
          to: [emailData.to],
          subject: emailData.subject,
          html: emailData.html,
          text: emailData.text || emailData.html.replace(/<[^>]*>/g, '')
        })
      })

      const responseText = await resendResponse.text()
      console.log('üì• Resend Response Status:', resendResponse.status)
      console.log('üì• Resend Response:', responseText)

      if (!resendResponse.ok) {
        console.error('‚ùå Error Resend:', responseText)
        console.error('‚ùå Status Code:', resendResponse.status)
        
        // Manejar error espec√≠fico de dominio no verificado
        let resendError: any = {}
        try {
          resendError = JSON.parse(responseText)
          console.error('‚ùå Resend Error Parsed:', resendError)
        } catch (e) {
          console.error('‚ùå Error parseando respuesta:', e)
          resendError = { message: responseText }
        }
        
        // Si es error 403 de validaci√≥n (dominio no verificado)
        const isDomainError = resendResponse.status === 403 && (
          resendError.message?.includes('only send testing emails') ||
          resendError.message?.includes('testing emails') ||
          resendError.message?.includes('verify a domain') ||
          responseText.includes('only send testing emails') ||
          responseText.includes('verify a domain')
        )
        
        if (isDomainError) {
          console.error('‚ùå Error 403: Dominio no verificado')
          const errorMessage = `Resend requiere verificar un dominio para enviar emails a otros destinatarios.

SOLUCI√ìN:
1. Verifica un dominio en Resend:
   - Ve a: https://resend.com/domains
   - Agrega tu dominio (puedes obtener uno gratis en Freenom: https://freenom.com)
   - Configura los registros DNS que Resend te indique
   
2. Actualiza RESEND_FROM_EMAIL en Supabase:
   - Supabase Dashboard ‚Üí Settings ‚Üí Edge Functions ‚Üí Secrets
   - Cambia RESEND_FROM_EMAIL a: Sistema de Gesti√≥n T√©cnica <noreply@tudominio.com>
   
3. Alternativa temporal (SOLO PARA PRUEBAS):
   - El email solo puede enviarse a: emersoncastro9.ec@gmail.com
   - Usa ese email para probar la funcionalidad
   
Para m√°s informaci√≥n, revisa: DOMINIOS_GRATIS_OPCIONES.md`
          
          // Retornar error directamente en lugar de lanzarlo
          return new Response(
            JSON.stringify({ 
              error: errorMessage
            }),
            { 
              status: 403,
              headers: { ...corsHeaders, 'Content-Type': 'application/json' }
            }
          )
        }
        
        // Otros errores de Resend
        const errorMsg = resendError.message || responseText || 'Error desconocido de Resend'
        return new Response(
          JSON.stringify({ 
            error: `Error enviando email con Resend: ${errorMsg}`,
            details: resendError
          }),
          { 
            status: resendResponse.status || 500,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
          }
        )
      }

      let resendData
      try {
        resendData = JSON.parse(responseText)
        console.log('‚úÖ Resend Data:', resendData)
      } catch (e) {
        console.warn('‚ö†Ô∏è No se pudo parsear respuesta de Resend:', e)
        resendData = { id: 'unknown', raw: responseText }
      }

      return new Response(
        JSON.stringify({ 
          success: true, 
          message: 'Email enviado exitosamente',
          provider: 'Resend',
          resendId: resendData.id || resendData.message_id,
          resendResponse: resendData
        }),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      )
    }

    // OPCI√ìN 3: Usar Brevo (antes Sendinblue)
    // Plan gratuito: 300 emails/d√≠a
    const brevoApiKey = Deno.env.get('BREVO_API_KEY')
    
    if (brevoApiKey) {
      const brevoResponse = await fetch('https://api.brevo.com/v3/smtp/email', {
        method: 'POST',
        headers: {
          'api-key': brevoApiKey,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          sender: {
            name: 'Sistema de Gesti√≥n T√©cnica',
            email: Deno.env.get('BREVO_FROM_EMAIL') || 'noreply@brevo.com'
          },
          to: [{ email: emailData.to }],
          subject: emailData.subject,
          htmlContent: emailData.html,
          textContent: emailData.text || emailData.html.replace(/<[^>]*>/g, '')
        })
      })

      if (!brevoResponse.ok) {
        const errorText = await brevoResponse.text()
        console.error('Error Brevo:', errorText)
        throw new Error(`Error enviando email con Brevo: ${errorText}`)
      }

      return new Response(
        JSON.stringify({ 
          success: true, 
          message: 'Email enviado exitosamente',
          provider: 'Brevo'
        }),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      )
    }

    // OPCI√ìN 4: Usar Mailgun
    const mailgunApiKey = Deno.env.get('MAILGUN_API_KEY')
    const mailgunDomain = Deno.env.get('MAILGUN_DOMAIN')
    
    if (mailgunApiKey && mailgunDomain) {
      const mailgunResponse = await fetch(
        `https://api.mailgun.net/v3/${mailgunDomain}/messages`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Basic ${btoa(`api:${mailgunApiKey}`)}`,
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            from: Deno.env.get('MAILGUN_FROM_EMAIL') || `noreply@${mailgunDomain}`,
            to: emailData.to,
            subject: emailData.subject,
            html: emailData.html,
            text: emailData.text || emailData.html.replace(/<[^>]*>/g, '')
          })
        }
      )

      if (!mailgunResponse.ok) {
        const errorText = await mailgunResponse.text()
        console.error('Error Mailgun:', errorText)
        throw new Error(`Error enviando email con Mailgun: ${errorText}`)
      }

      return new Response(
        JSON.stringify({ 
          success: true, 
          message: 'Email enviado exitosamente',
          provider: 'Mailgun'
        }),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      )
    }

    // OPCI√ìN 5: Usar Amazon SES (Muy econ√≥mico)
    // Casi gratis para vol√∫menes peque√±os
    const awsAccessKey = Deno.env.get('AWS_SES_ACCESS_KEY')
    const awsSecretKey = Deno.env.get('AWS_SES_SECRET_KEY')
    const awsRegion = Deno.env.get('AWS_SES_REGION') || 'us-east-1'
    
    if (awsAccessKey && awsSecretKey) {
      // Amazon SES requiere firma AWS v4 (m√°s complejo)
      // Por simplicidad, solo mostramos que est√° disponible
      // Se puede implementar m√°s adelante si es necesario
      console.log('Amazon SES detectado pero requiere implementaci√≥n adicional de firma AWS')
    }

    // OPCI√ìN 6: Fallback - No hay servicio configurado
    console.log('‚ö†Ô∏è No hay servicio de email configurado')
    console.log('üìã Servicios verificados:')
    console.log('  - SENDGRID_API_KEY:', sendGridApiKey ? '‚úÖ Configurado' : '‚ùå No configurado')
    console.log('  - RESEND_API_KEY:', resendApiKey ? '‚úÖ Configurado' : '‚ùå No configurado')
    console.log('  - BREVO_API_KEY:', brevoApiKey ? '‚úÖ Configurado' : '‚ùå No configurado')
    console.log('  - MAILGUN_API_KEY:', mailgunApiKey ? '‚úÖ Configurado' : '‚ùå No configurado')
    console.log('  - MAILGUN_DOMAIN:', mailgunDomain ? '‚úÖ Configurado' : '‚ùå No configurado')
    console.log('  - ENVIRONMENT:', Deno.env.get('ENVIRONMENT') || 'No configurado')
    console.log('üìß Email que se hubiera enviado:')
    console.log({
      to: emailData.to,
      subject: emailData.subject,
      // No loguear el contenido completo por seguridad
    })

    // Mensaje de error m√°s descriptivo
    const errorMessage = `No hay servicio de email configurado. Por favor, configura al menos uno de estos servicios en Supabase Dashboard ‚Üí Settings ‚Üí Edge Functions ‚Üí Secrets:

1. RESEND_API_KEY (Recomendado - Gratis, 3,000 emails/mes)
   - Obt√©n tu API key en: https://resend.com
   - Agrega: RESEND_API_KEY = re_xxxxxxxxxxxxx
   - Agrega: RESEND_FROM_EMAIL = Sistema de Gesti√≥n T√©cnica <onboarding@resend.dev>

2. SENDGRID_API_KEY
   - Obt√©n tu API key en: https://sendgrid.com
   - Agrega: SENDGRID_API_KEY = SG.xxxxxxxxxxxxx
   - Agrega: SENDGRID_FROM_EMAIL = noreply@tudominio.com

3. BREVO_API_KEY
   - Obt√©n tu API key en: https://brevo.com
   - Agrega: BREVO_API_KEY = xxxxxxxxxxxxx
   - Agrega: BREVO_FROM_EMAIL = noreply@tudominio.com

4. MAILGUN_API_KEY + MAILGUN_DOMAIN
   - Obt√©n tu API key en: https://mailgun.com
   - Agrega: MAILGUN_API_KEY = xxxxxxxxxxxxx
   - Agrega: MAILGUN_DOMAIN = mg.tudominio.com
   - Agrega: MAILGUN_FROM_EMAIL = noreply@tudominio.com

Para m√°s informaci√≥n, revisa: DIAGNOSTICO_ERROR_500_EMAIL.md`

    throw new Error(errorMessage)

  } catch (error: any) {
    console.error('‚ùå Error en send-email:', error)
    console.error('‚ùå Stack trace:', error.stack)
    console.error('‚ùå Error type:', error.constructor.name)
    
    // Proporcionar mensaje de error m√°s descriptivo
    let errorMessage = error.message || 'Error desconocido al enviar email'
    
    // Si es un error de parseo JSON, proporcionar ayuda
    if (error instanceof SyntaxError || error.message?.includes('JSON')) {
      errorMessage = 'Error al procesar los datos del email. Verifica que los datos est√©n en formato JSON v√°lido.'
    }
    
    return new Response(
      JSON.stringify({ 
        error: errorMessage,
        details: Deno.env.get('ENVIRONMENT') === 'development' ? error.stack : undefined
      }),
      { 
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    )
  }
})
